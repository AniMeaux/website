# Base stage for all subsequent stages.
FROM node:22.11-bullseye-slim AS base

# Needed for Prisma generation and runtime.
RUN apt-get update && apt-get install -y openssl

# The store dir will be `$PNPM_HOME/store`.
# See https://pnpm.io/settings#storedir
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

RUN corepack enable

# There's an ongoing issue with corepack.
# See https://github.com/nodejs/corepack/issues/612#issuecomment-2630469508
RUN npm i -g corepack@latest

WORKDIR /workspace

# Populate pnpm store with all dependencies (prod and dev).
# See https://pnpm.io/cli/fetch#usage-scenario
FROM base AS pnpm-store

COPY pnpm-lock.yaml pnpm-workspace.yaml ./

RUN pnpm fetch

# Remove the virtual store so we can copy the entire `/workspace` directory.
RUN rm -rf node_modules

# App and its dependencies' `package.json` files.
FROM base AS packages-json

COPY package.json ./
COPY libs/core/package.json libs/core/
COPY libs/file-storage/package.json libs/file-storage/
COPY libs/form-data/package.json libs/form-data/
COPY libs/password/package.json libs/password/
COPY libs/prisma/package.json libs/prisma/
COPY libs/react-primitives/package.json libs/react-primitives/
COPY libs/search-params-io/package.json libs/search-params-io/
COPY libs/tailwind-animation/package.json libs/tailwind-animation/
COPY libs/zod-utils/package.json libs/zod-utils/
COPY apps/admin/package.json apps/admin/

# App production build.
FROM base AS build

COPY --from=pnpm-store ${PNPM_HOME}/store ${PNPM_HOME}/store
COPY --from=pnpm-store /workspace ./
COPY --from=packages-json /workspace ./

RUN pnpm install --frozen-lockfile --offline

COPY tsconfig.base.json ./
COPY libs/core libs/core
COPY libs/file-storage libs/file-storage
COPY libs/form-data libs/form-data
COPY libs/password libs/password
COPY libs/prisma libs/prisma
COPY libs/react-primitives libs/react-primitives
COPY libs/search-params-io libs/search-params-io
COPY libs/tailwind-animation libs/tailwind-animation
COPY libs/zod-utils libs/zod-utils
COPY apps/admin apps/admin

# Generate code of app's dependencies.
RUN pnpm --filter admin^... generate

RUN pnpm --filter admin build

# Production image with minimal footprint.
FROM base AS app

ENV NODE_ENV="production"

COPY --from=pnpm-store ${PNPM_HOME}/store ${PNPM_HOME}/store
COPY --from=pnpm-store /workspace ./
COPY --from=packages-json /workspace ./

RUN pnpm install --prod --frozen-lockfile --offline

COPY --from=build /workspace/apps/admin/build apps/admin/build
COPY --from=build /workspace/apps/admin/public apps/admin/public
COPY libs/prisma/migrations libs/prisma/migrations
COPY libs/prisma/schema.prisma libs/prisma/schema.prisma

CMD ["pnpm", "--filter", "admin", "start"]
